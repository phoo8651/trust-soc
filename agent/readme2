# Secure Log Agent PoC (Week 3 Scope)

## 1. Goals

- 애플리케이션/NGINX 로그를 안전하게 중앙으로 전송
- 에이전트 코드/서비스를 직접 수정하지 않고, 중앙에서 정책/명령 제어
- 토큰/시크릿 분리, 재전송 방지(HMAC), 최소 권한(systemd 하드닝) 적용

## 2. Architecture Overview

1. **otel-agent (OpenTelemetry Collector)**
   - `filelog` receiver로 `/var/log/nginx/access.log` 수집
   - `transform/pii_mask` 로 민감 정보 마스킹 (예: IP)
   - `batch`, `file_storage`, `queued_retry` 로 무손실/재시도 보장
   - OTLP/HTTP exporter:
     - endpoint: `http://127.0.0.1:19000/v1/logs` (Secure Forwarder)
     - token: `LOCAL_TOKEN` (에이전트 전용 토큰)

2. **Secure Forwarder (/opt/secure-forwarder)**
   - 로컬에서 `/v1/logs` 수신
   - `Authorization: Bearer LOCAL_TOKEN` 검증
   - 중앙 Ingest 서버로 포워딩:
     - `Authorization: Bearer LOG_TOKEN`
     - `X-Request-Timestamp`, `X-Nonce`, `X-Idempotency-Key`,
       `X-Payload-Hash`, `X-Signature` (HMAC-SHA256) 추가
   - 역할: 로컬 에이전트와 중앙 서버 사이의 HMAC 게이트웨이

3. **Ingest & Control Server (PoC)**
   - `POST /v1/logs`
     - `LOG_TOKEN` + HMAC 검증 후 로그 수신 (현재는 콘솔 출력)
   - `POST /api/agents/{id}/commands/enqueue`
     - 내부 관리자/룰엔진이 사용하는 제어 엔드포인트
     - `CTRL_TOKEN` 기반 인증
   - `GET /api/agents/{id}/commands`
     - Agent Controller가 pending 명령 조회
     - `CTRL_TOKEN` + HMAC 검증
   - `POST /api/agents/{id}/commands/{cmd_id}/ack`
     - Agent Controller가 처리 결과 보고
     - `CTRL_TOKEN` + HMAC 검증
   - 저장소는 메모리 기반 (PoC) → 실서비스에서는 DB/Queue로 교체

4. **Agent Controller (/opt/agent-controller)**
   - systemd 서비스로 상시 동작
   - 주기적으로 Control Server에서 명령 pull
   - 지원 명령:
     - `ping` : 연결 확인
     - `reload_agent` : `systemctl restart otel-agent`
     - `update_config` :
       - `/etc/secure-log-agent/remote.d/remote.yaml` 생성/갱신
       - `systemctl reload otel-agent`
   - 모든 호출에 `CTRL_TOKEN` + HMAC-SHA256 사용

## 3. Security Design

- **Token Separation**
  - `LOCAL_TOKEN` : otel-agent -> Secure Forwarder (호스트 내부)
  - `LOG_TOKEN`   : Secure Forwarder -> Ingest (로그 채널)
  - `CTRL_TOKEN`  : Agent Controller/관리자 -> Control API (제어 채널)
- **HMAC Protection**
  - 로그 포워딩 및 제어 플레인에 대해
    - `X-Request-Timestamp`, `X-Nonce`, `X-Payload-Hash`, `X-Signature`
    - 재전송 공격 및 payload 변조 방지
- **Secrets Management**
  - 모든 토큰/HMAC 키는 systemd `Environment=`로 주입
  - 설정 파일(agent.yaml 등)에 시크릿 직접 기록 금지
- **Systemd Hardening**
  - `NoNewPrivileges`, `ProtectSystem=full`, `RestrictSUIDSGID`,
    `ProtectKernel*`, `RestrictNamespaces`, `RestrictAddressFamilies` 등 적용
  - 필요한 디렉터리만 `ReadWritePaths`로 허용
- **Least Privilege**
  - otel-agent: `otel-agent` 전용 계정으로 실행
  - secure-forwarder, agent-controller: root이지만 sandbox 옵션으로 제한
    (실운영 시 sudo 정책/전용 계정으로 더 분리 가능)

## 4. Next Steps (Beyond Week 3)

- Ingest/Control Server를 실제 DB/Rule Engine과 연동
- 에이전트 토큰 발급/회전 API 및 콘솔
- 추가 PII redaction 규칙, multi-tenant RBAC 적용
