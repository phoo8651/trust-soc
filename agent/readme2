# Secure Log Agent PoC



## 1. Goals

- 애플리케이션/NGINX 로그를 안전하게 중앙으로 전송
- 에이전트 코드/서비스를 직접 수정하지 않고, 중앙에서 정책/명령 제어
- 토큰/시크릿 분리, 재전송 방지(HMAC), 최소 권한(systemd 하드닝) 적용
- 새 VM 환경에서도 스크립트 한 번으로 에이전트 스택 설치/등록 가능하게 만들기

---

## 2. Architecture Overview

### 2.1 OTEL Agent (`otel-agent`)

- OpenTelemetry Collector 기반 로그 에이전트
- `filelog` receiver로 `/var/log/nginx/access.log` 수집
- `transform/pii_mask` 로 기본 PII(IP 등) 마스킹
- `batch`, `file_storage`, `queued_retry` 로 무손실/재시도 보장
- OTLP/HTTP exporter:
  - endpoint: `http://127.0.0.1:19000/v1/logs` (Secure Forwarder)
  - token: `LOCAL_TOKEN` (에이전트 전용 토큰)
- 실행:
  - 시스템 계정: `otel-agent`
  - 설정: `/etc/secure-log-agent/agent.yaml`
  - remote 설정: `/etc/secure-log-agent/remote.d/remote.yaml`

### 2.2 Secure Forwarder

- 위치: `~/lastagent/forwarder/secure-forwarder.py`
- 역할:
  - 로컬에서 `/v1/logs` 수신
  - `Authorization: Bearer LOCAL_TOKEN` 검증
  - 중앙 Ingest 서버로 포워딩:
    - `Authorization: Bearer LOG_TOKEN`
    - `X-Request-Timestamp`, `X-Nonce`, `X-Idempotency-Key`,
      `X-Payload-Hash`, `X-Signature` (HMAC-SHA256) 추가
  - 로컬 에이전트와 중앙 서버 사이의 HMAC 게이트웨이 역할

### 2.3 Ingest & Control Server (PoC)

- Ingest API (`/v1/logs`)
  - `LOG_TOKEN` + HMAC 검증 후 로그 수신 (현재는 콘솔 출력)
- Control API (에이전트 원격 명령 채널)
  - `POST /api/agents/{id}/commands/enqueue`
    - 내부 관리자/룰엔진이 사용하는 제어 엔드포인트
    - `CTRL_TOKEN` 기반 인증
  - `GET /api/agents/{id}/commands`
    - Agent Controller가 pending 명령 조회
    - `CTRL_TOKEN` + HMAC 검증
  - `POST /api/agents/{id}/commands/{cmd_id}/ack`
    - Agent Controller가 처리 결과 보고
    - `CTRL_TOKEN` + HMAC 검증
- 저장소는 메모리 기반 (PoC)
  - 실서비스에서는 DB/Queue로 교체 예정

### 2.4 Agent Controller

- 위치: `~/lastagent/agent/agent_controller.py`
- systemd 서비스로 상시 동작
- 주기적으로 Control Server에서 명령 pull
- 지원 명령:
  - `ping` : 연결 확인
  - `reload_agent` : `systemctl restart otel-agent`
  - `update_config` :
    - `/etc/secure-log-agent/remote.d/remote.yaml` 생성/갱신
    - `systemctl reload otel-agent`
- 모든 호출에 `CTRL_TOKEN` + HMAC-SHA256 사용

---

## 3. Repository & Runtime Layout

기본 예시는 `last` 계정, `/home/last/lastagent` 기준입니다.

```bash
/home/last/lastagent
├── agent/
│   ├── agent_controller.py
│   └── agent-controller.service        # systemd 유닛 템플릿
├── forwarder/
│   ├── secure-forwarder.py
│   └── secure-forwarder.service        # systemd 유닛 템플릿
├── etc/
│   ├── agent.yaml                      # OTEL 에이전트 메인 설정
│   ├── .env                            # 토큰/URL/HMAC 등 시크릿 (git ignore 대상)
│   └── otel-agent.service              # OTEL 에이전트 systemd 유닛 템플릿
├── venv/                               # Python 가상환경 (install 스크립트가 생성)
└── install_lastagent.sh                # 자동 설치 스크립트
