# OpenTelemetry Collector 기반 로그 에이전트 설정 파일
# - Text4Shell / nginx 로그 파일을 tail 해서 읽고
# - IPv4 주소를 마스킹한 뒤
# - secure-forwarder(INGEST_ENDPOINT)로 OTLP/HTTP 전송
# /etc/secure-log-agent/agent.yaml

extensions:
  health_check: {}
  file_storage:
    # [수정] Forwarder가 읽는 경로와 겹치지 않도록 변경
    directory: /var/lib/secure-log-agent/otel_storage 

receivers:
  filelog:
    include:
      - /var/log/nginx/access.log
      - /var/log/text4shell/application.log
    start_at: end
    storage: file_storage

processors:
  memory_limiter:
    check_interval: 2s
    limit_mib: 256
  batch:
    timeout: 1s
    send_batch_size: 1024
  transform/pii_mask:
    error_mode: ignore
    log_statements:
      - context: log
        statements:
          - replace_pattern(body, "([0-9]{1,3}\\.){3}[0-9]{1,3}", "[ip_redacted]")

exporters:
  otlphttp:
    # Secure Forwarder가 리슨할 주소
    endpoint: ${env:INGEST_ENDPOINT} 
    logs_endpoint: /v1/logs
    headers:
      Authorization: "Bearer ${env:INGEST_TOKEN}"
    sending_queue:
      enabled: true
      num_consumers: 4
      queue_size: 262144
      storage: file_storage
    retry_on_failure:
      enabled: true
      initial_interval: 1s

  debug:
    verbosity: basic

service:
  telemetry:
    metrics:
      level: none
  extensions: [health_check, file_storage]
  pipelines:
    logs:
      receivers: [filelog]
      processors: [memory_limiter, transform/pii_mask, batch]
      exporters: [otlphttp, debug]