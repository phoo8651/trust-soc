# OpenTelemetry Collector 기반 로그 에이전트 설정
# 역할:
# 1) nginx access 로그를 tail 해서 읽는다.
# 2) IPv4 주소를 단순 마스킹한다.
# 3) batch + 디스크 큐로 안정적으로 전송한다.
# 4) OTLP/HTTP로 별도 수집 서버(또는 secure-forwarder)에 전송한다.
#    - 서버 주소/토큰은 환경변수 INGEST_ENDPOINT / INGEST_TOKEN 으로만 받는다.

extensions:
  health_check: {}
  file_storage:
    # 디스크 기반 큐/오프셋 저장소
    directory: /var/lib/secure-log-agent/queue
    create_directory: true
    # sudo chown -R otel-agent:nogroup /var/lib/secure-log-agent < 입력해야 쓰기 권한 받게 되어 있습니다. 자동쉘에 포함 되어있음

receivers:
  filelog:
    include:
      - /var/log/nginx/access.log
      - /var/log/text4shell/app.log    # ← Text4Shell 기본 경로 추가
      - /var/log/containers/*_poc-lab_*.log   # poc-lab 네임스페이스의 PoC 컨테이너 로그
    start_at: end
    storage: file_storage  # file_storage extensions 사용

processors:
  memory_limiter:
    check_interval: 2s
    limit_mib: 256

  batch:
    timeout: 1s
    send_batch_size: 1024
    send_batch_max_size: 2048

  transform/pii_mask:
    error_mode: ignore
    log_statements:
      - context: log
        statements:
          - replace_pattern(body, "([0-9]{1,3}\\.){3}[0-9]{1,3}", "[ip_redacted]")

exporters:
  otlphttp:
    # secure-forwarder 또는 ingest 서버 주소
    endpoint: ${env:INGEST_ENDPOINT}
    logs_endpoint: /v1/logs

    headers:
      Authorization: "Bearer ${env:INGEST_TOKEN}"

    sending_queue:
      enabled: true
      num_consumers: 4
      queue_size: 262144
      storage: file_storage

    retry_on_failure:
      enabled: true
      initial_interval: 1s
      max_interval: 30s
      max_elapsed_time: 0s

  debug:
    verbosity: basic

service:
  telemetry:
    metrics:
      address: 0.0.0.0:8889

  extensions:
    - health_check
    - file_storage

  pipelines:
    logs:
      receivers: [filelog]
      processors:
        - memory_limiter
        - transform/pii_mask
        - batch
      exporters:
        - otlphttp
        - debug
