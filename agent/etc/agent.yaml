# /etc/secure-log-agent/agent.yaml

extensions:
  health_check: {}
  # [중요] 내부 버퍼 저장소 경로를 Forwarder가 건드리지 않는 곳으로 지정
  file_storage:
    directory: /var/lib/secure-log-agent/otel_storage
    create_directory: true

receivers:
  filelog:
    include:
      - /var/log/text4shell/application.log
      - /var/log/sqli/application.log
    start_at: end
    storage: file_storage

processors:
  batch:
    timeout: 1s
    send_batch_size: 1024

  # 간단한 PII 마스킹
  transform/pii_mask:
    error_mode: ignore
    log_statements:
      - context: log
        statements:
          - replace_pattern(body, "([0-9]{1,3}\\.){3}[0-9]{1,3}", "[ip_redacted]")

exporters:
  # [핵심] 로컬 Secure Forwarder에게 HTTP로 전송
  otlphttp:
    endpoint: http://127.0.0.1:19000
    logs_endpoint: /v1/logs
    # 로컬 통신용 토큰 (secure-forwarder.py의 LOCAL_TOKEN과 일치해야 함)
    headers:
      Authorization: "Bearer ${env:INGEST_TOKEN}"

    # 전송 실패시 재시도 설정
    retry_on_failure:
      enabled: true
      initial_interval: 1s
      max_interval: 10s

    # 디스크 버퍼링 사용
    sending_queue:
      enabled: true
      storage: file_storage

service:
  extensions: [health_check, file_storage]
  pipelines:
    logs:
      receivers: [filelog]
      processors: [transform/pii_mask, batch]
      exporters: [otlphttp]
