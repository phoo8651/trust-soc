# /etc/secure-log-agent/agent.yaml

# OpenTelemetry Collector 기반 로그 에이전트 설정
# 역할:
# 1) nginx / text4shell / PoC 컨테이너 로그 파일을 tail 해서 읽는다.
# 2) IPv4 주소를 단순 마스킹한다.
# 3) batch + 디스크 큐로 안정적으로 전송한다.
# 4) OTLP/HTTP 로 secure-forwarder(ingest 엔드포인트)에 전송한다.
#    - 서버 주소/토큰은 환경변수 INGEST_ENDPOINT / INGEST_TOKEN 으로만 받는다.

extensions:
  health_check: {}
  file_storage:
    # 디스크 기반 큐/오프셋 저장소
    directory: /var/lib/secure-log-agent/queue
    create_directory: true

receivers:
  filelog:
    include:
      - /var/log/nginx/access.log
      - /var/log/text4shell/application.log     # ← 실제 text4shell 로그 경로
      - /var/log/containers/*_poc-lab_*.log     # (있으면) poc-lab 네임스페이스 컨테이너 로그
    start_at: end
    storage: file_storage   # file_storage extensions 사용

processors:
  memory_limiter:
    check_interval: 2s
    limit_mib: 256

  batch:
    timeout: 1s
    send_batch_size: 1024
    send_batch_max_size: 2048

  transform/pii_mask:
    error_mode: ignore
    log_statements:
      - context: log
        statements:
          # IPv4 주소는 전부 [ip_redacted] 로 마스킹
          - replace_pattern(body, "([0-9]{1,3}\\.){3}[0-9]{1,3}", "[ip_redacted]")

exporters:
  otlphttp:
    # secure-forwarder 또는 ingest 서버 주소
    # 예시: INGEST_ENDPOINT=http://127.0.0.1:19000
    endpoint: ${env:INGEST_ENDPOINT}
    logs_endpoint: /v1/logs

    headers:
      # 예시: INGEST_TOKEN=dev_local_agent_token
      Authorization: "Bearer ${env:INGEST_TOKEN}"

    sending_queue:
      enabled: true
      num_consumers: 4
      queue_size: 262144
      storage: file_storage

    retry_on_failure:
      enabled: true
      initial_interval: 1s
      max_interval: 30s
      max_elapsed_time: 0s  # 무제한 retry

  debug:
    verbosity: basic

service:
  telemetry:
    metrics:
      level: none

  extensions:
    - health_check
    - file_storage

  pipelines:
    logs:
      receivers:
        - filelog
      processors:
        - memory_limiter
        - transform/pii_mask
        - batch
      exporters:
        - otlphttp
        - debug
