[Unit]
Description=Secure Log Agent (filelog -> OTLP/HTTP via Secure Forwarder)
After=network-online.target
Wants=network-online.target

[Service]
Type=simple

User=otel-agent               # 전용 계정으로 실행 (root 아님)
Group=nogroup                 # 불필요한 그룹 권한 제거
WorkingDirectory=/etc/secure-log-agent

ExecStart=/usr/local/bin/otelcol-contrib \
  --config=/etc/secure-log-agent/agent.yaml \
  --config=/etc/secure-log-agent/remote.d/remote.yaml

Restart=always
RestartSec=5

########## Hardening ##########

NoNewPrivileges=true
# 프로세스와 자식들이 setuid, setcap 등으로 "새 권한"을 얻지 못하게 막음.
# 취약점 터져도 추가 권한 상승이 어렵게 만드는 기본 안전장치.

PrivateTmp=true
# 다른 서비스와 /tmp 파일을 공유하지 않도록 분리.

ProtectSystem=full
# ReadWritePaths 로 허용한 경로만 쓰기 가능하게 제한.

ProtectHome=true
# 에이전트가 사용자 홈 디렉토리 건드리지 못하게 함.

ProtectControlGroups=true
# cgroup 트리 수정 금지. 시스템 전체 리소스 제어에 손 못 대게 함.

ProtectKernelLogs=true
# /dev/kmsg 등 커널 로그 직접 읽기 금지.

ProtectKernelModules=true
# 커널 모듈 로드/언로드 금지.

ProtectKernelTunables=true
# /proc/sys, /sys 등 커널 튜닝 값 변경 금지.

RestrictSUIDSGID=true
# setuid/setgid 바이너리 사용 제한. 특권 상승용 바이너리 악용 방지.

RestrictNamespaces=true
# 새 네임스페이스(unshare 등) 생성 차단. 컨테이너/샌드박스 악용 방지.

LockPersonality=true
# 프로세스 ABI 변경(personality syscall) 금지. 특수 공격면 축소.

RestrictAddressFamilies=AF_INET AF_INET6 AF_UNIX
# IPv4, IPv6, Unix 소켓만 허용. 다른 프로토콜(RAW, netlink 등) 사용 차단.

ReadWritePaths=/etc/secure-log-agent
ReadWritePaths=/var/lib/otelcol-contrib
ReadWritePaths=/var/log

[Install]
WantedBy=multi-user.target
