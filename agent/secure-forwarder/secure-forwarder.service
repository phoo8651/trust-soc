[Unit]
Description=Secure Log Forwarder (HMAC gate for /v1/logs)
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
User=root                         # 19000 포트 listen + 간단해서 root 유지 (추후 전용 계정 분리 가능)
WorkingDirectory=/opt/secure-forwarder
#로컬 테스트용
Environment="LOCAL_TOKEN=dev_agent_token"
Environment="UPSTREAM_URL=http://127.0.0.1:8000/v1/logs"
Environment="UPSTREAM_LOG_TOKEN=dev_log_token"
Environment="HMAC_SECRET=super_secret_hmac_key"
Environment="LISTEN_HOST=127.0.0.1"
Environment="LISTEN_PORT=19000"
# 실제 서비스/공유용 
#Environment="LOCAL_TOKEN=${LOCAL_TOKEN}"          # 예: dev_agent_token
#Environment="UPSTREAM_URL=http://127.0.0.1:8000/v1/logs"
#Environment="UPSTREAM_LOG_TOKEN=${LOG_TOKEN}"     # 예: dev_log_token
#Environment="HMAC_SECRET=${HMAC_SECRET}"          # 예: super_secret_hmac_key

ExecStart=/usr/bin/python3 /opt/secure-forwarder/secure_forwarder.py

Restart=always
RestartSec=3


NoNewPrivileges=true
# forwarder 자체도 추가 권한(setuid 등) 못 얻도록.

PrivateTmp=true
# 독립된 /tmp 사용.

ProtectSystem=full
# 시스템 중요 경로 읽기 전용. 코드/환경설정 외에는 쓰기 불가.

ProtectHome=true
# 홈 디렉토리 접근 차단.

ProtectControlGroups=true
ProtectKernelLogs=true
ProtectKernelModules=true
ProtectKernelTunables=true
# 커널/컨트롤그룹 관련으로  민감 자원 건드리지 못하게하기 위해

RestrictSUIDSGID=true
RestrictNamespaces=true
LockPersonality=true
# 권한 상승 / 네임스페이스 악용 / ABI 변경 차단.

RestrictAddressFamilies=AF_INET AF_INET6 AF_UNIX
# HTTP만 쓰니까 이 정도만 허용.방향성에 따라 차후 수정 가능

PrivateDevices=true
# /dev 접근 최소화. 거의 모든 디바이스 파일을 숨김.

ReadOnlyPaths=/opt/secure-forwarder
# 코드 디렉토리는 읽기 전용. 실행 중에 forwarder 코드 바뀌지 않게 하는 부분.

[Install]
WantedBy=multi-user.target
