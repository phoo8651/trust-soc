# OpenTelemetry Collector 기반 로그 에이전트 설정
# 역할:
# 1) nginx access 로그를 tail 해서 읽는다.
# 2) IPv4 주소를 단순 마스킹한다.
# 3) batch + 디스크 큐로 안정적으로 전송한다.
# 4) OTLP/HTTP로 별도 수집 서버(또는 secure-forwarder)에 전송한다.
#    - 서버 주소/토큰은 환경변수 INGEST_ENDPOINT / INGEST_TOKEN 으로만 받는다.

extensions:
  health_check:
    # 헬스체크 엔드포인트 제공 (기본 :13133)
    # 예) curl http://127.0.0.1:13133/healthz
  file_storage:
    # 디스크 기반 큐/오프셋 저장소
    # - filelog의 읽은 위치(offset)
    # - sending_queue의 큐 데이터
    # 를 이 디렉토리에 저장해서 재시작 시 이어갈 수 있게 한다.
    directory: /var/lib/secure-log-agent/queue

receivers:
  filelog:
    # 수집 대상 로그 파일 목록 (nginx access 로그 예시)
    include:
      - /var/log/nginx/access.log
    start_at: end          # 에이전트 시작 시 파일 끝부터 읽기 시작
    storage: file_storage  # 읽은 위치를 위 file_storage에 기록 (재시작 시 복구)

processors:
  memory_limiter:
    # Collector 프로세스 메모리 사용량 보호용
    check_interval: 2s
    limit_mib: 256

  batch:
    # 로그를 모아서 전송 (성능/안정성용)
    timeout: 1s
    send_batch_size: 1024
    send_batch_max_size: 2048

  transform/pii_mask:
    # 간단한 PII(IPv4) 마스킹 예시
    error_mode: ignore
    log_statements:
      - context: log
        statements:
          # log body 안의 IPv4 패턴을 [ip_redacted] 로 치환
          - replace_pattern(body, "([0-9]{1,3}\\.){3}[0-9]{1,3}", "[ip_redacted]")

exporters:
  otlphttp:
    # 전송 대상 endpoint
    # 운영에서는 secure-forwarder 또는 실제 ingest 서버 주소를
    # 환경변수 INGEST_ENDPOINT 로 주입해서 사용
    endpoint: ${env:INGEST_ENDPOINT}
    # 서버 측에서 로그를 받는 경로
    logs_endpoint: /v1/logs

    headers:
      # 인증 토큰도 설정파일에 직접 쓰지 않고
      # 환경변수 INGEST_TOKEN 에서만 읽는다.
      Authorization: "Bearer ${env:INGEST_TOKEN}"

    sending_queue:
      # 메모리 큐 + 디스크 저장으로 무손실/재시도 구조
      enabled: true
      num_consumers: 4
      queue_size: 262144
      storage: file_storage   # 위에서 정의한 file_storage 사용

    retry_on_failure:
      # 전송 실패 시 자동 재시도(backoff)
      enabled: true
      initial_interval: 1s
      max_interval: 30s
      max_elapsed_time: 0s    # 0 = 시간 제한 없이 계속 재시도

  debug:
    # 디버그용: 처리된 로그를 stdout에 출력
    # 개발/테스트 때만 켜고, 운영에서는 필요 시 제거 가능
    verbosity: basic

service:
  telemetry:
    metrics:
      # Collector 자체 메트릭 노출 (상태 확인용)
      address: 0.0.0.0:8889

  extensions:
    # 위에서 정의한 extension 활성화
    - health_check
    - file_storage

  pipelines:
    logs:
      # logs 파이프라인:
      # filelog → memory_limiter → pii_mask → batch → otlphttp(+debug)
      receivers: [filelog]
      processors:
        - memory_limiter
        - transform/pii_mask
        - batch
      exporters:
        - otlphttp
        - debug
