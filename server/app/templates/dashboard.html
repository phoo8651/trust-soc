{% extends "base.html" %}

{% block content %}
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100;">
  <div id="incidentToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header bg-danger text-white">
      <strong class="me-auto">ðŸš¨ New Incident Detected!</strong>
      <small>Just now</small>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
    <div class="toast-body">
      <p id="toastSummary" class="mb-1 fw-bold">Suspicious activity detected</p>
      <div class="d-flex justify-content-between align-items-center">
        <span id="toastConfidence" class="badge bg-warning text-dark">Conf: 85%</span>
        <a href="/console/incidents" class="btn btn-sm btn-outline-danger">View Details</a>
      </div>
    </div>
  </div>
</div>

<div class="alert alert-primary d-flex align-items-center justify-content-between shadow-sm mb-4" role="alert">
  <div>
    <i class="bi bi-key-fill me-2"></i>
    <strong>Current Agent Registration Key (Valid for 5 mins):</strong>
    <code class="fs-5 ms-2 user-select-all"
      style="background-color: rgba(255,255,255,0.5); padding: 2px 8px; border-radius: 4px;">{{ bootstrap_secret }}</code>
  </div>
  <small class="text-muted">Use this key in <code>install_lastagent.sh</code></small>
</div>

<div class="row mb-4">
  <div class="col-md-3">
    <div class="card card-stat shadow-sm">
      <div class="card-body">
        <h6 class="text-muted">Connected Agents</h6>
        <h2>{{ stats.agents }}</h2>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card card-stat shadow-sm" style="border-left-color: #198754;">
      <div class="card-body">
        <h6 class="text-muted">Total Logs</h6>
        <h2>{{ stats.logs }}</h2>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card card-stat shadow-sm" style="border-left-color: #ffc107;">
      <div class="card-body">
        <h6 class="text-muted">Total Incidents</h6>
        <h2>{{ stats.incidents }}</h2>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card card-alert shadow-sm">
      <div class="card-body">
        <h6 class="text-muted">Pending Approval (HIL)</h6>
        <h2 class="text-danger">{{ stats.pending }}</h2>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-md-8">
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-white">
        <h5 class="mb-0">ðŸš¨ Recent Incidents</h5>
      </div>
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead>
            <tr>
              <th>Time</th>
              <th>Summary</th>
              <th>Severity</th>
              <th>Status</th>
              <th>Conf.</th>
            </tr>
          </thead>
          <tbody>
            {% for inc in incidents %}
            <tr>
              <td>{{ inc.created_at.strftime('%H:%M:%S') }}</td>
              <td title="{{ inc.summary }}">{{ inc.summary[:50] }}...</td>
              <td>
                <span class="badge {% if inc.confidence > 80 %}bg-danger{% else %}bg-warning{% endif %}">
                  {{ "High" if inc.confidence > 80 else "Medium" }}
                </span>
              </td>
              <td>
                {% if inc.status == 'pending_approval' %}
                <span class="badge bg-info text-dark">Pending</span>
                {% elif inc.status == 'approved' %}
                <span class="badge bg-success">Approved</span>
                {% else %}
                <span class="badge bg-secondary">{{ inc.status }}</span>
                {% endif %}
              </td>
              <td>{{ inc.confidence }}%</td>
            </tr>
            {% else %}
            <tr>
              <td colspan="5" class="text-center py-3 text-muted">No recent incidents.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="col-md-4">
    <div class="card shadow-sm">
      <div class="card-header bg-white">
        <h5 class="mb-0">âš¡ Recent Jobs</h5>
      </div>
      <ul class="list-group list-group-flush">
        {% for job in jobs %}
        <li class="list-group-item d-flex justify-content-between align-items-center">
          <div>
            <small class="text-muted">{{ job.created_at.strftime('%H:%M:%S') }}</small><br>
            <strong>{{ job.job_type }}</strong>
          </div>
          <span class="badge bg-secondary">{{ job.status }}</span>
        </li>
        {% else %}
        <li class="list-group-item text-center text-muted py-3">No jobs found.</li>
        {% endfor %}
      </ul>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // íŽ˜ì´ì§€ ë¡œë“œ ì‹œì ì„ ê¸°ì¤€ ì‹œê°„ìœ¼ë¡œ ì„¤ì • (Unix Timestamp)
    let lastCheckTime = Math.floor(Date.now() / 1000);
    const toastEl = document.getElementById('incidentToast');
    const toast = new bootstrap.Toast(toastEl);

    // 5ì´ˆë§ˆë‹¤ ì„œë²„ì— ìƒˆë¡œìš´ ì‚¬ê³ ê°€ ìžˆëŠ”ì§€ í™•ì¸
    setInterval(function () {
      fetch(`/console/api/updates?last_check=${lastCheckTime}`)
        .then(response => response.json())
        .then(data => {
          // í˜„ìž¬ ì‹œê°„ì„ ê°±ì‹  (ë‹¤ìŒ í™•ì¸ì„ ìœ„í•´)
          lastCheckTime = Math.floor(Date.now() / 1000);

          if (data.has_new && data.incident) {
            // ì•Œë¦¼ ë‚´ìš© ì±„ìš°ê¸°
            document.getElementById('toastSummary').textContent = data.incident.summary;
            const confSpan = document.getElementById('toastConfidence');
            confSpan.textContent = `Conf: ${data.incident.confidence}%`;

            // íŒì—… í‘œì‹œ
            toast.show();
          }
        })
        .catch(err => console.error('Polling error:', err));
    }, 5000);
  });
</script>
{% endblock %}